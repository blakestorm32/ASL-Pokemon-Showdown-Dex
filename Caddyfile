# Primary site
dex.pokemonshowdown.com {
	# (Optional) Set your web root
	# root * /var/www/dex

	# If you're behind a proxy that sets X-Forwarded-Proto: http, bounce to HTTPS (302)
	@xfproto header X-Forwarded-Proto http
	redir @xfproto https://dex.pokemonshowdown.com{uri} 302

	# Canonical host: www → apex (301)
	# (We also define a dedicated server block for the www host below.)
	# redir https://dex.pokemonshowdown.com{uri} permanent

	# Deny PUT and DELETE like the Apache <Limit> block did
	@deny method PUT DELETE
	respond @deny 403

	# Block .git directory
	@git path /.git/*
	respond @git 403

	# Redirect /pokedex... → /  (302)
	@pokedex path_regexp pokedex ^/pokedex(/.*)?$
	redir @pokedex / 302

	# Rewrite these app routes to index.php (QSA-equivalent: Caddy keeps the query string)
	@app path_regexp app ^/(pokemon|items|abilities|tags|egggroups|moves|types|tiers|categories)(/.*)?$
	rewrite @app /index.php

	# /articles/<slug> → index.php
	@articles path_regexp articles ^/articles/[a-z0-9]+/?$
	rewrite @articles /index.php

	# Serve PHP only for *.php (so non-existent static files won’t fall into PHP)
	@php path *.php
	php_fastcgi @php php:9000
	# If you use a Unix socket instead:
	# php_fastcgi @php unix//run/php/php-fpm.sock

	# Static files (and default 404 for missing files, e.g. apple-touch-icon-precomposed.png)
	file_server
}

# Canonical host redirect (www → apex)
www.dex.pokemonshowdown.com {
	redir https://dex.pokemonshowdown.com{uri} permanent
}
